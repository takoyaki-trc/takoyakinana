<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>菜々カレンダー</title>
  <meta name="description" content="たこ焼き 菜々：営業日カレンダー（自動切替 / A4横印刷対応）" />

  <style>
    :root{
      --paper:#fff;
      --ink:#111;
      --muted:#333;

      --grid:#8f9aa5;
      --grid2:#c4ccd4;

      --band:#d85c61;
      --band2:#c94d53;

      --sun:#d04545;
      --sat:#2f6bff;

      --cellbg:#ffffff;     /* 通常は白 */
      --offbg:#ffe9eb;      /* 休みだけ薄ピンク */
      --off:#d24a4a;

      --stampRed:#d53737;
      --stampYellow:#ffd54a;
      --stampBorder:#c79b18;

      --edoBold: "HGP太行書体","HGS太行書体","DFP太行書体","Yuji Syuku","Yuji Mai","Klee One","Noto Serif JP","Hiragino Mincho ProN","Yu Mincho",serif;

      /* ✅ “日付を守る”ための安全領域（右上に確保） */
      --stampSafeW: 56px;   /* バッジが入る横幅分 */
      --stampSafeH: 44px;   /* バッジが入る高さ分 */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
      color:var(--ink);
      min-height:100svh;
      background:
        linear-gradient(90deg,
          rgba(120,80,40,.22) 0%,
          rgba(140,95,50,.18) 12%,
          rgba(110,70,35,.22) 24%,
          rgba(155,105,60,.16) 36%,
          rgba(115,75,40,.22) 48%,
          rgba(145,95,55,.18) 60%,
          rgba(105,65,35,.22) 72%,
          rgba(150,100,58,.16) 84%,
          rgba(120,80,40,.22) 100%
        ),
        radial-gradient(circle at 20% 10%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,.25), rgba(255,255,255,0) 60%),
        linear-gradient(#caa67b, #b88f63);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 12px 24px;
    }

    .printScale{ display:block; }

    .sheet{
      background: var(--paper);
      border: 1px solid #d9d9d9;
      box-shadow: 0 14px 40px rgba(0,0,0,.18);
      border-radius: 10px;
      overflow: hidden;
    }

    /* ===== 上帯 ===== */
    .band{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
      padding: 14px 12px;
      background: linear-gradient(180deg,var(--band),var(--band2));
      color:#fff;
      font-weight: 1000;
      letter-spacing:.04em;
    }
    .band-month{
      font-size: 30px;
      color:#ffd56b;
      text-shadow: 0 2px 0 rgba(0,0,0,.18);
    }
    .band-title{ font-size: 30px; }

    /* ===== 曜日 ===== */
    .dow{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      background: #fff;
      border-top: 2px solid var(--grid);
      border-bottom: 2px solid var(--grid);
      font-weight: 1000;
    }
    .dow > div{
      text-align:center;
      padding: 10px 0;
      border-right: 1px solid var(--grid2);
      font-size: 18px;
      background:#fff;
    }
    .dow > div:last-child{ border-right:none; }
    .dow .sun{ color:var(--sun); }
    .dow .sat{ color:var(--sat); }

    /* ===== カレンダーグリッド ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      grid-auto-rows: 78px;
      background: #fff;
      border-bottom: 2px solid var(--grid);
    }

    .cell{
      position:relative;
      background: var(--cellbg);
      border-right: 1px solid var(--grid2);
      border-bottom: 1px solid var(--grid2);
      padding: 8px;
      overflow:hidden;
    }
    .cell:nth-child(7n){ border-right:none; }
    .cell.blank{ opacity:.28; background:#fff; }

    /* ✅ 日付は左上固定 */
    .day{
      position:absolute;
      left: 8px;
      top: 8px;
      font-weight:1000;
      font-size: 26px;
      line-height:1;
      z-index:5;                 /* 常に最前面 */
      pointer-events:none;
      text-shadow: 0 1px 0 rgba(255,255,255,.55);
    }
    .cell.sun .day{ color:var(--sun); }
    .cell.sat .day{ color:var(--sat); }

    /* ✅ スタンプが付く日は “右上安全領域” を先に確保（=日付の右側に空き） */
    .cell.hasStamp .day{
      padding-right: var(--stampSafeW);
    }

    /* 休みマスだけ背景色 */
    .cell.isOff{ background: var(--offbg); }

    /* 休：右下 */
    .offMark{
      position:absolute;
      right: 8px;
      bottom: 8px;
      font-weight:1000;
      font-size: 26px;
      color: var(--off);
      opacity:.95;
      pointer-events:none;
      z-index:3;
    }

    /* ✅ スタンプ2倍：さらに小型化＆行間圧縮＆右上に完全固定 */
    .stampBadge{
      position:absolute;
      right: 4px;
      top: 4px;
      transform: rotate(-8deg);
      transform-origin: top right;
      background: radial-gradient(circle at 30% 25%, #fff7c7 0%, var(--stampYellow) 45%, #ffbf2f 100%);
      border: 2px solid var(--stampBorder);
      border-radius: 11px;
      padding: 4px 5px;
      text-align:center;
      font-weight:1000;
      color: var(--stampRed);
      box-shadow: 0 3px 0 rgba(0,0,0,.14);
      pointer-events:none;
      z-index:2; /* 日付より後ろ */
      width: 50px;

      /* ✅ 文字が増えても高さを取りすぎない */
      line-height: 1;
    }
    .stampBadge .top{
      font-size: 10px;
      letter-spacing: 0;
      white-space:nowrap;
      margin:0;
      padding:0;
      line-height: 1;
    }
    .stampBadge .bottom{
      font-size: 12px;
      margin-top: 0px;      /* 行間を詰める */
      white-space:nowrap;
      line-height: 1;
    }
    .stampBadge::before{
      content:"✦";
      position:absolute;
      left:-6px;
      top:-10px;
      font-size: 12px;
      color:#fff;
      text-shadow: 0 0 6px rgba(255,255,255,.9), 0 1px 0 rgba(0,0,0,.08);
      transform: rotate(10deg);
      opacity:.95;
    }

    /* ===== 下段 ===== */
    .foot{
      padding: 12px 14px 14px;
      background:#fff;
    }

    .hoursLine{
      display:grid;
      grid-template-columns: auto 1fr;
      align-items:end;
      column-gap: 12px;
    }
    .hoursLabel{
      font-weight:1000;
      font-size: 22px;
      white-space:nowrap;
      line-height:1;
    }
    .hoursTime{
      font-weight:1000;
      font-size: 54px;
      letter-spacing:.01em;
      white-space:nowrap;
      line-height:1;
      overflow:hidden;
    }
    .hoursTime .lo{
      font-size: 18px;
      margin-left: 8px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }

    .warn{
      margin-top: 8px;
      font-size: 16px;
      color: var(--muted);
      line-height:1.35;
    }

    .shopName{
      margin-top: 10px;
      text-align:center;
      font-family: var(--edoBold);
      font-weight: 1000;
      font-size: 46px;
      letter-spacing:.06em;
      line-height:1.05;
      white-space:nowrap;
      text-shadow:
        0 1px 0 rgba(0,0,0,.12),
        1px 0 0 rgba(0,0,0,.08),
        -1px 0 0 rgba(0,0,0,.08),
        0 -1px 0 rgba(0,0,0,.08);
    }

    .telRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:nowrap;
      min-width:0;
    }
    .telBadge{
      flex:0 0 auto;
      background:#333;
      color:#fff;
      font-weight:1000;
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 6px;
      white-space:nowrap;
    }
    .telLine{
      flex:1 1 auto;
      text-align:right;
      font-weight: 1000;
      font-size: 18px;
      white-space:nowrap;
      min-width:0;
    }
    .telLine .num{
      font-size: 32px;
      letter-spacing:.02em;
    }

    /* 操作ボタン */
    .bars{
      margin-top: 10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .bars button{
      border:1px solid rgba(0,0,0,.18);
      background:rgba(255,255,255,.9);
      padding:10px 12px;
      border-radius:10px;
      font-weight:1000;
      cursor:pointer;
    }

    /* ===== スマホ ===== */
    @media (max-width: 520px){
      .grid{ grid-auto-rows: 64px; }

      .day{ font-size: 22px; left:6px; top:6px; }
      .cell.hasStamp .day{ padding-right: 50px; } /* スマホは安全領域も少し小さめ */

      .offMark{ font-size: 20px; right: 6px; bottom: 6px; }

      /* ✅ バッジをさらに縮小して“絶対に被らない” */
      .stampBadge{
        width: 44px;
        padding: 3px 4px;
        border-radius: 10px;
        right: 3px;
        top: 3px;
        border-width: 2px;
      }
      .stampBadge .top{ font-size: 9px; }
      .stampBadge .bottom{ font-size: 11px; }
      .stampBadge::before{ left:-6px; top:-10px; font-size: 11px; }

      .hoursLabel{ font-size: 18px; }
      .hoursTime{ font-size: 40px; }
      .hoursTime .lo{ font-size: 14px; }

      .shopName{ font-size: 40px; }

      .telBadge{
        font-size: 13px;
        padding: 7px 9px;
      }
      .telLine{ font-size: 14px; }
      .telLine .num{ font-size: 22px; }
    }

    /* ===== 印刷（A4横） ===== */
    @page{
      size: A4 landscape;
      margin: 5mm; /* 少しだけ余白、用紙いっぱい感 */
    }
    @media print{
      *{
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      body{ background:#fff !important; }
      .wrap{ max-width:none !important; padding:0 !important; margin:0 !important; }
      .bars{ display:none !important; }

      /* ✅ 用紙いっぱい：縮小しない */
      .printScale{
        transform: none !important;
        width: 100% !important;
      }

      .sheet{
        width: 100% !important;
        margin: 0 !important;
        border: 0.35mm solid #777 !important;
        box-shadow:none !important;
        border-radius:0 !important;
      }

      /* ✅ 印刷は文字を大きく */
      .band{ padding: 7mm 5mm !important; }
      .band-month{ font-size: 11mm !important; }
      .band-title{ font-size: 11mm !important; }

      .dow{ border-top:0.4mm solid #666 !important; border-bottom:0.4mm solid #666 !important; }
      .dow > div{
        border-right:0.25mm solid #999 !important;
        padding: 2.8mm 0 !important;
        font-size: 4.4mm !important;
      }

      .grid{
        grid-auto-rows: 21mm !important; /* 少し大きく */
        border-bottom:0.4mm solid #666 !important;
        background:#fff !important;
      }
      .cell{
        border-right:0.25mm solid #999 !important;
        border-bottom:0.25mm solid #999 !important;
        padding: 2.4mm 2.4mm !important;
        background:#fff !important;
      }
      .cell.isOff{ background: var(--offbg) !important; }

      .day{
        font-size: 7.0mm !important; /* 日付も大きく */
        left: 2.4mm !important;
        top: 2.2mm !important;
        z-index:5 !important;
      }
      .cell.hasStamp .day{
        padding-right: 18mm !important; /* 印刷でも安全領域確保 */
      }

      .offMark{
        font-size: 6.2mm !important;
        right: 2.4mm !important;
        bottom: 2.2mm !important;
      }

      /* 印刷バッジ：小さめ維持（被りゼロ優先） */
      .stampBadge{
        width: 16mm !important;
        padding: 1.5mm 1.2mm !important;
        border-radius: 3mm !important;
        right: 2mm !important;
        top: 2mm !important;
        border-width: 0.6mm !important;
        box-shadow: 0 1mm 0 rgba(0,0,0,.14) !important;
        z-index:2 !important;
      }
      .stampBadge .top{ font-size: 3.1mm !important; }
      .stampBadge .bottom{ font-size: 3.4mm !important; margin-top:0 !important; }
      .stampBadge::before{ font-size: 3.8mm !important; left:-1.6mm !important; top:-2.8mm !important; }

      .foot{ padding: 5mm 7mm 5.5mm !important; }

      .hoursLabel{ font-size: 5.6mm !important; }
      .hoursTime{ font-size: 14.2mm !important; }
      .hoursTime .lo{ font-size: 4.0mm !important; }

      .warn{ font-size: 4.0mm !important; }

      .shopName{ font-size: 12.0mm !important; }

      .telRow{ flex-wrap:nowrap !important; gap: 3mm !important; }
      .telBadge{ font-size: 4.0mm !important; padding: 2.0mm 2.8mm !important; }
      .telLine{ font-size: 4.2mm !important; }
      .telLine .num{ font-size: 7.0mm !important; }

      .sheet, .band, .dow, .grid, .foot{
        break-inside:avoid !important;
        page-break-inside:avoid !important;
      }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="printScale">
      <section class="sheet" aria-label="営業日カレンダー">
        <div class="band">
          <div class="band-month" id="bandMonth">3月</div>
          <div class="band-title">菜々カレンダー</div>
        </div>

        <div class="dow">
          <div class="sun">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div class="sat">土</div>
        </div>

        <div class="grid" id="calGrid"></div>

        <div class="foot">
          <div class="hoursLine">
            <div class="hoursLabel">営業時間</div>
            <div class="hoursTime">11:00 ～ 19:30 <span class="lo">(L.O.)</span></div>
          </div>

          <div class="warn">※材料、または店主の元気がなくなり次第終了する場合があります。</div>

          <div class="shopName">たこ焼き&nbsp;菜々</div>

          <div class="telRow">
            <div class="telBadge">電話注文受付ます</div>
            <div class="telLine">TEL <span class="num">070-4077-7732</span></div>
          </div>
        </div>
      </section>
    </div>

    <div class="bars">
      <button id="prevBtn" type="button">← 先月</button>
      <button id="todayBtn" type="button">今月</button>
      <button id="nextBtn" type="button">来月 →</button>
      <button id="printBtn" type="button">A4で印刷</button>
    </div>
  </main>

  <script>
  (() => {
    "use strict";

    const $ = (s, el=document) => el.querySelector(s);
    const gridEl = $("#calGrid");
    const bandMonthEl = $("#bandMonth");

    const prevBtn = $("#prevBtn");
    const nextBtn = $("#nextBtn");
    const todayBtn = $("#todayBtn");
    const printBtn = $("#printBtn");

    let view = (() => {
      const d = new Date();
      return { y: d.getFullYear(), m: d.getMonth()+1 };
    })();

    let DATA = { overrides: {} };

    function pad2(n){ return String(n).padStart(2,"0"); }
    function ymKey(y,m){ return `${y}-${pad2(m)}`; }
    function ymd(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
    function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
    function firstDow(y,m){ return new Date(y, m-1, 1).getDay(); }

    function isBaseOff(y,m,d){
      const dt = new Date(y, m-1, d);
      const dow = dt.getDay();
      if(dow === 3) return true; // 水
      if(dow === 4){ // 木：第2/第3
        let count = 0;
        for(let i=1;i<=d;i++){
          if(new Date(y, m-1, i).getDay() === 4) count++;
        }
        return (count === 2 || count === 3);
      }
      return false;
    }

    function isAutoStampDay(d){ return (d === 7 || d === 17 || d === 27); }

    async function loadData(){
      try{
        const res = await fetch("assets/calendar-data.json", { cache:"no-store" });
        if(!res.ok) throw new Error("calendar-data.json not found");
        const json = await res.json();
        if(json && typeof json === "object") DATA = json;
      }catch(e){
        DATA = { overrides: {} };
      }
    }

    function getMonthOverride(y,m){
      const key = ymKey(y,m);
      return (DATA.overrides && DATA.overrides[key]) ? DATA.overrides[key] : null;
    }

    function clearGrid(){
      while(gridEl.firstChild) gridEl.removeChild(gridEl.firstChild);
    }

    function render(){
      const {y,m} = view;
      bandMonthEl.textContent = `${m}月`;

      const ov = getMonthOverride(y,m);
      const manualOff = new Set((ov && ov.off) ? ov.off : []);
      const manualTags = (ov && ov.tags) ? ov.tags : {};

      clearGrid();

      const start = firstDow(y,m);
      const last = daysInMonth(y,m);

      for(let i=0;i<start;i++){
        const c = document.createElement("div");
        c.className = "cell blank";
        gridEl.appendChild(c);
      }

      for(let d=1; d<=last; d++){
        const dateStr = ymd(y,m,d);
        const dow = new Date(y, m-1, d).getDay();

        const cell = document.createElement("div");
        cell.className = "cell";
        if(dow === 0) cell.classList.add("sun");
        if(dow === 6) cell.classList.add("sat");

        const day = document.createElement("div");
        day.className = "day";
        day.textContent = String(d);
        cell.appendChild(day);

        const off = isBaseOff(y,m,d) || manualOff.has(dateStr);

        if(off){
          cell.classList.add("isOff");
          const o = document.createElement("div");
          o.className = "offMark";
          o.textContent = "休";
          cell.appendChild(o);
        }else{
          let tag = "";
          if(manualTags[dateStr]) tag = String(manualTags[dateStr]);

          const shouldAuto = isAutoStampDay(d);

          if(tag || shouldAuto){
            cell.classList.add("hasStamp"); // ✅ 安全領域確保

            const badge = document.createElement("div");
            badge.className = "stampBadge";

            const top = document.createElement("div");
            top.className = "top";
            top.textContent = tag ? tag : "スタンプ";

            const bottom = document.createElement("div");
            bottom.className = "bottom";
            bottom.textContent = "2倍";

            badge.appendChild(top);
            badge.appendChild(bottom);
            cell.appendChild(badge);
          }
        }

        gridEl.appendChild(cell);
      }

      const mod = gridEl.children.length % 7;
      if(mod !== 0){
        const need = 7 - mod;
        for(let i=0;i<need;i++){
          const c = document.createElement("div");
          c.className = "cell blank";
          gridEl.appendChild(c);
        }
      }
    }

    function addMonth(delta){
      let y = view.y;
      let m = view.m + delta;
      while(m <= 0){ m += 12; y--; }
      while(m >= 13){ m -= 12; y++; }
      view = { y, m };
      render();
    }

    async function init(){
      await loadData();
      render();

      prevBtn.addEventListener("click", () => addMonth(-1));
      nextBtn.addEventListener("click", () => addMonth(1));
      todayBtn.addEventListener("click", () => {
        const d = new Date();
        view = { y:d.getFullYear(), m:d.getMonth()+1 };
        render();
      });
      printBtn.addEventListener("click", () => window.print());
    }

    init();
  })();
  </script>
</body>
</html>
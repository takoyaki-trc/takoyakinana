<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ãŸã“ç„¼ãèœã€…ï½œç„¼ããŸã¦ã«ã“ã ã‚ã‚‹ ãŸã“ç„¼ãå±‹</title>
<meta name="description" content="ãŸã“ç„¼ãèœã€…å…¬å¼ã€‚å®šç•ªï¼ˆ8å€‹450å††ï¼‰/ã·ã‚‰ç™¾ï¼ˆ8å€‹550å††ï¼‰/çœŸã£é»’ã„ã‹ã•ã¾ç„¼ãã€‚é›»è©±æ³¨æ–‡ 070-4077-7732ã€‚ç„¼ãä¸ŠãŒã‚Šã¾ã§ç´„20åˆ†ã€‚å¤©æ°—ã§ãŠã™ã™ã‚ãŒå¤‰ã‚ã‚‹ã€‚" />

<style>
  :root{
    --bg:#fff7f7;
    --bg2:#fffdf7;
    --card:#ffffff;
    --line: rgba(20,10,12,.12);
    --text:#1a1315;
    --muted: rgba(26,19,21,.68);

    --red1:#ff2d55;
    --red2:#ff6a3d;
    --red3:#ffb800;
    --sky:#4aa8ff;

    --shadow: 0 18px 40px rgba(0,0,0,.10);
    --shadow2: 0 10px 24px rgba(0,0,0,.10);
    --r:18px;
    --max: 1120px;

    /* Deck */
    --deckH: 360px;          /* ã‚¹ãƒãƒ›ã§ç¸¦ã«é•·ã™ããªã„ */
    --cardR: 18px;
    --glow: 0 12px 28px rgba(255,45,85,.14);
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at 20% 10%, rgba(255,45,85,.10), transparent 40%),
      radial-gradient(circle at 85% 8%, rgba(74,168,255,.10), transparent 42%),
      radial-gradient(circle at 70% 75%, rgba(255,182,0,.10), transparent 45%),
      linear-gradient(180deg, var(--bg), var(--bg2));
  }

  a{ color:inherit; text-decoration:none }
  button{ font:inherit }
  img{ max-width:100%; display:block }

  .wrap{
    width:min(var(--max), 100%);
    margin:0 auto;
    padding: 14px 12px calc(22px + env(safe-area-inset-bottom));
  }

  header{
    position:sticky;
    top:0;
    z-index:50;
    backdrop-filter: blur(10px);
    padding: 10px 0 12px;
  }
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 10px 12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.78);
    border-radius: 16px;
    box-shadow: var(--shadow2);
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    min-width:0;
  }
  .logo{
    width:38px; height:38px; border-radius:12px;
    background:
      radial-gradient(circle at 35% 35%, rgba(255,255,255,.8), rgba(255,255,255,0) 55%),
      linear-gradient(135deg, var(--red1), var(--red2), var(--red3));
    box-shadow: 0 10px 22px rgba(255,45,85,.20);
    border:1px solid rgba(0,0,0,.06);
    flex:0 0 auto;
  }
  .brand .t{ min-width:0; }
  .brand .name{
    font-weight: 1000;
    letter-spacing:.02em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    line-height:1.1;
  }
  .brand .sub{
    margin-top:3px;
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .actions{
    display:flex; gap:8px; flex:0 0 auto; align-items:center;
  }
  .btn{
    border:1px solid var(--line);
    background: #fff;
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    display:inline-flex; align-items:center; gap:8px;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    box-shadow: 0 10px 20px rgba(0,0,0,.06);
    user-select:none;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0px) scale(.98); box-shadow:none; }
  .btn.call{
    background: linear-gradient(180deg, rgba(255,45,85,.12), rgba(255,255,255,1));
    border-color: rgba(255,45,85,.25);
  }
  .btn.ghost{ background: rgba(255,255,255,.55); }

  .section{
    margin-top: 12px;
    border-radius: var(--r);
    border:1px solid var(--line);
    background: rgba(255,255,255,.80);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .head{
    padding: 12px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom: 1px solid rgba(0,0,0,.06);
    background:
      radial-gradient(circle at 15% 20%, rgba(255,45,85,.06), transparent 55%),
      radial-gradient(circle at 85% 25%, rgba(74,168,255,.06), transparent 55%),
      #fff;
  }
  .head .h{
    display:flex; align-items:center; gap:10px;
    font-weight: 1000;
    letter-spacing:.02em;
  }
  .dot{
    width:10px; height:10px; border-radius:99px;
    background: linear-gradient(180deg, var(--red1), var(--red2), var(--red3));
    box-shadow: 0 0 0 2px rgba(255,255,255,.9);
  }
  .head .sub{
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
    text-align:right;
  }
  .body{ padding: 12px 14px 14px; }

  /* ===== é©šãï¼šDECK UI ===== */
  .deckArea{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap: 12px;
    align-items:stretch;
  }
  @media (max-width:900px){
    .deckArea{ grid-template-columns: 1fr; }
  }

  .deck{
    border-radius: var(--cardR);
    border:1px solid rgba(0,0,0,.08);
    background: #fff;
    box-shadow: var(--shadow2);
    position:relative;
    overflow:hidden;
    height: var(--deckH);
  }

  /* ã‚¹ãƒãƒ›ã§ã¡ã‚‡ã†ã©ã„ã„é«˜ã• */
  @media (max-width:480px){
    :root{ --deckH: 320px; }
  }

  .deckBg{
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 20% 20%, rgba(255,45,85,.10), transparent 45%),
      radial-gradient(circle at 80% 22%, rgba(74,168,255,.10), transparent 45%),
      linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.76));
    pointer-events:none;
  }

  .stack{
    position:absolute; inset:0;
    padding: 12px;
  }

  .cardItem{
    position:absolute;
    inset: 12px;
    border-radius: 18px;
    overflow:hidden;
    border:1px solid rgba(0,0,0,.08);
    background:#f3f3f3;
    box-shadow: 0 14px 28px rgba(0,0,0,.10);
    transform-origin: 50% 100%;
    transition: transform .22s ease, opacity .18s ease;
    touch-action: pan-y;
  }

  .cardItem img{
    width:100%;
    height:100%;
    object-fit: cover;
  }

  /* ã‚¹ã‚¿ãƒƒã‚¯ã®â€œæŸæ„Ÿâ€ */
  .cardItem[data-depth="1"]{ transform: translate(6px, 6px) scale(.985) rotate(.25deg); opacity:.92; filter:saturate(.98); }
  .cardItem[data-depth="2"]{ transform: translate(12px, 12px) scale(.97) rotate(.5deg); opacity:.84; filter:saturate(.96); }
  .cardItem[data-depth="3"]{ transform: translate(18px, 18px) scale(.955) rotate(.75deg); opacity:.74; filter:saturate(.94); }

  /* è¡¨ï¼ˆãƒˆãƒƒãƒ—ï¼‰ */
  .cardItem.isTop{
    transform: translate(0,0) scale(1) rotate(0deg);
    opacity:1;
    box-shadow: 0 18px 36px rgba(0,0,0,.14), var(--glow);
    border-color: rgba(255,45,85,.18);
  }

  /* ã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ */
  .cardItem.isDragging{
    transition: none !important;
    cursor: grabbing;
  }

  .cardOverlay{
    position:absolute;
    left: 12px; right: 12px; bottom: 12px;
    border-radius: 16px;
    background: rgba(255,255,255,.86);
    border:1px solid rgba(0,0,0,.08);
    box-shadow: 0 12px 22px rgba(0,0,0,.10);
    padding: 10px 10px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
  }
  .cName{
    font-weight: 1100;
    letter-spacing:.02em;
    line-height:1.2;
  }
  .cMeta{
    margin-top:4px;
    font-size: 12px;
    color: var(--muted);
    line-height:1.5;
  }
  .cPrice{
    font-weight: 1100;
    white-space:nowrap;
    font-size: 13px;
  }

  .deckHint{
    position:absolute;
    left: 12px; top: 12px;
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
    z-index: 3;
    pointer-events:none;
  }
  .pill{
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 999px;
    border:1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.86);
    box-shadow: 0 10px 18px rgba(0,0,0,.08);
    font-weight: 900;
  }
  .pill.red{ border-color: rgba(255,45,85,.25); }
  .pill.sky{ border-color: rgba(74,168,255,.25); }
  .pill.sun{ border-color: rgba(255,182,0,.25); }
  .pill.gray{ border-color: rgba(0,0,0,.10); color: rgba(26,19,21,.80); }

  .deckCtrls{
    display:flex; gap:8px; flex-wrap:wrap;
    margin-top: 10px;
  }
  .deckCtrls .btn{ flex:1 1 auto; justify-content:center; }

  /* å³å´ï¼šã‚«ãƒ†ã‚´ãƒªåˆ‡æ›¿ã¨èª¬æ˜ï¼ˆæ–‡å­—ã‚’æœ€å°ã«ï¼‰ */
  .side{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .heroTitle{
    font-size: clamp(18px, 2.5vw, 28px);
    font-weight: 1000;
    letter-spacing:.02em;
    margin:0;
    line-height:1.15;
  }
  .lead{
    margin:0;
    color:var(--muted);
    line-height:1.75;
    font-size: 14px;
  }

  .switchRow{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .seg{
    flex:1 1 auto;
    border:1px solid rgba(0,0,0,.10);
    background:#fff;
    border-radius: 999px;
    padding: 10px 12px;
    font-weight: 1000;
    cursor:pointer;
    box-shadow: 0 10px 20px rgba(0,0,0,.06);
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    text-align:center;
    user-select:none;
  }
  .seg:hover{ transform: translateY(-1px); }
  .seg.active{
    border-color: rgba(255,45,85,.25);
    background: linear-gradient(180deg, rgba(255,45,85,.10), #fff);
  }

  .infoBox{
    border-radius: 16px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    padding: 12px;
    box-shadow: 0 12px 22px rgba(0,0,0,.06);
  }
  .infoBox .k{
    font-weight: 1100;
    letter-spacing:.02em;
  }
  .infoBox .p{
    margin-top:6px;
    color: var(--muted);
    font-size: 13px;
    line-height:1.75;
  }

  footer{
    margin-top: 14px;
    text-align:center;
    color: rgba(26,19,21,.70);
    font-size: 12px;
    line-height: 1.7;
    padding: 12px 6px 0;
  }
  .footerLinks{
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    margin-top: 10px;
  }
</style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="t">
          <div class="name">ãŸã“ç„¼ãèœã€…</div>
          <div class="sub">ç„¼ããŸã¦ã«ã“ã ã‚ã‚‹ï½œé›»è©±æ³¨æ–‡ï¼š070-4077-7732</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn call" href="tel:07040777732">ğŸ“ é›»è©±æ³¨æ–‡</a>
        <a class="btn ghost" href="https://takoyaki-trc.github.io/takoyaki-media/town/cardlist.html" target="_blank" rel="noopener">ğŸŒ€ ãƒˆãƒ¬ã‚«</a>
      </div>
    </div>
  </header>

  <!-- ===== é©šãï¼šãƒ¡ãƒ‹ãƒ¥ãƒ¼DECK ===== -->
  <section class="section" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‡ãƒƒã‚­è¡¨ç¤ºï¼‰">
    <div class="head">
      <div class="h"><span class="dot"></span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆã‚ãã‚‹ã ã‘ï¼‰</div>
      <div class="sub">ä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸è¦ï½œæŒ‡ã§ã‚·ãƒ¥ãƒƒ</div>
    </div>

    <div class="body">
      <div class="deckArea">

        <!-- å·¦ï¼šã‚«ãƒ¼ãƒ‰æŸ -->
        <div>
          <div class="deck" id="deck" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰æŸ">
            <div class="deckBg" aria-hidden="true"></div>

            <div class="deckHint">
              <span class="pill red" id="wxPill">å¤©æ°—åˆ¤å®šä¸­â€¦</span>
              <span class="pill gray" id="tmpPill">--â„ƒ</span>
              <span class="pill gray" id="modePill">ãŠã™ã™ã‚</span>
            </div>

            <div class="stack" id="stack"></div>

            <div class="cardOverlay" aria-live="polite">
              <div>
                <div class="cName" id="cName">ã‚½ãƒ¼ã‚¹</div>
                <div class="cMeta" id="cMeta">æŒ‡ã§å·¦å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã™ã‚‹ã¨æ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
              </div>
              <div class="cPrice" id="cPrice">ã€Š8å€‹ 450å††ã€‹</div>
            </div>
          </div>

          <div class="deckCtrls">
            <button class="btn" id="btnNext" type="button">ğŸ‘‰ æ¬¡ã¸</button>
            <button class="btn" id="btnShuffle" type="button">ğŸ² ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
          </div>
        </div>

        <!-- å³ï¼šãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
        <div class="side">
          <h1 class="heroTitle">å†™çœŸã¯å¤§ããã€ä¸¦ã¹ãªã„ã€‚</h1>
          <p class="lead">
            ã‚¹ãƒãƒ›ã§â€œãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒãŒç¸¦ã«é•·ã™ãã‚‹å•é¡Œâ€ã‚’æ½°ã™ãŸã‚ã€<br>
            <b>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚«ãƒ¼ãƒ‰æŸã¨ã—ã¦è¡¨ç¤º</b>ã—ã¾ã™ã€‚<br>
            è¦‹ã‚‹ã®ãŒæ¥½ã—ã„ã®ã«ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å¢—ãˆã¾ã›ã‚“ã€‚
          </p>

          <div class="switchRow" role="tablist" aria-label="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰">
            <button class="seg active" id="segRec" type="button">ãŠã™ã™ã‚</button>
            <button class="seg" id="segStd" type="button">å®šç•ª450</button>
            <button class="seg" id="segPlus" type="button">ã·ã‚‰ç™¾550</button>
            <button class="seg" id="segBoss" type="button">ã„ã‹ã•ã¾</button>
          </div>

          <div class="infoBox" id="infoBox">
            <div class="k">ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆå¤©æ°—ã§å¤‰ã‚ã‚‹ï¼‰</div>
            <div class="p">
              é›¨ãƒ»æ¹¿åº¦é«˜ã‚ï¼šãƒãƒ¼ã‚ºã‚½ãƒ¼ã‚¹ãƒãƒ¨ï¼ã­ãå‘³å™Œï¼ã‚ã‚“ãŸã„ãƒãƒ¨<br>
              æš‘ã„æ—¥ï¼šè¾›å£ã‚½ãƒ¼ã‚¹ï¼å¡©ã“ã—ã‚‡ã†ï¼ç‰¡è £ã ã—é†¤æ²¹ï¼ã™ã£ã´ã‚“<br>
              ãã®ä»–ï¼šã‚½ãƒ¼ã‚¹
            </div>
          </div>

          <div class="infoBox">
            <div class="k">ãƒˆãƒƒãƒ”ãƒ³ã‚°</div>
            <div class="p">
              ç„¡æ–™2ã¤ã¾ã§ï¼šãƒãƒ¨ãƒ»ä¸€å‘³ãƒãƒ¨ãƒ»ã‹ã¤ãŠã¶ã—ãƒ»å±±æ¤’<br>
              æœ‰æ–™ï¼šã­ã +50å††ï¼ã‹ã‚‰ã—ãƒãƒ¨ +50å††
            </div>
          </div>

          <a class="btn call" href="tel:07040777732" style="justify-content:center;">ğŸ“ é›»è©±æ³¨æ–‡ã™ã‚‹</a>
        </div>

      </div>
    </div>
  </section>

  <footer>
    <div><b>ãŸã“ç„¼ãèœã€…</b>ï½œé›»è©±æ³¨æ–‡ï¼š<a href="tel:07040777732">070-4077-7732</a></div>
    <div>ç„¼ãä¸ŠãŒã‚Šã¾ã§ç´„20åˆ†ï¼ˆç„¼ããŸã¦ã«ã“ã ã‚ã£ã¦ã„ã¾ã™ï¼‰</div>
    <div class="footerLinks">
      <a class="btn ghost" href="https://takoyaki-trc.github.io/takoyaki-media/town/cardlist.html" target="_blank" rel="noopener">ğŸŒ€ ãƒˆãƒ¬ã‚«</a>
      <a class="btn call" href="tel:07040777732">ğŸ“ æ³¨æ–‡</a>
    </div>
    <div style="margin-top:10px; opacity:.75;">ã€Šä»Šæ—¥ã‚‚ã ã‚Œã‹ãŒãŸã“ç„¼ãã‚’é£Ÿã¹ã¦ã„ã‚‹ã€€èœã€…ã€‹</div>
  </footer>

</div>

<script>
(() => {
  "use strict";

  // =========================
  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾©ï¼ˆç”»åƒãƒ»ä¾¡æ ¼ï¼‰
  // =========================
  const MENU = [
    // 550
    { id:"teritama", name:"ã¦ã‚ŠãŸã¾", price:550, cat:"plus", img:"https://ul.h3z.jp/S507mjUX.jpg" },
    { id:"negimiso", name:"ã­ãå‘³å™Œ", price:550, cat:"plus", img:"https://ul.h3z.jp/CcWfr8d0.JPG" },
    { id:"age_dama_karashi", name:"ã¶ã£ã‹ã‘æšã’ç‰ã‹ã‚‰ã—ãƒãƒ¨", price:550, cat:"plus", img:"https://ul.h3z.jp/Z680luDn.JPG" },
    { id:"shio_mayo_pepper", name:"å¡©ãƒãƒ¨ãƒšãƒƒãƒ‘ãƒ¼", price:550, cat:"plus", img:"https://ul.h3z.jp/hwUJtJOS.JPG" },
    { id:"cheese_sauce_mayo", name:"ãƒãƒ¼ã‚ºã‚½ãƒ¼ã‚¹ãƒãƒ¨", price:550, cat:"plus", img:"https://ul.h3z.jp/zQvjz2vk.JPG" },
    { id:"mentai_mayo", name:"ã‚ã‚“ãŸã„ãƒãƒ¨", price:550, cat:"plus", img:"https://ul.h3z.jp/bibwTWq6.JPG" },

    // 450
    { id:"shio_kosho", name:"å¡©ã“ã—ã‚‡ã†", price:450, cat:"std", img:"https://ul.h3z.jp/SLJuBJs1.jpg" },
    { id:"suppin", name:"ã™ã£ã´ã‚“", price:450, cat:"std", img:"https://ul.h3z.jp/mEuk5OwJ.jpg" },
    { id:"karakuchi_sauce", name:"è¾›å£ã‚½ãƒ¼ã‚¹", price:450, cat:"std", img:"https://ul.h3z.jp/Jit1r3Jv.JPG" },
    { id:"kaki_dashi", name:"ç‰¡è £ã ã—é†¤æ²¹", price:450, cat:"std", img:"https://ul.h3z.jp/k7J0DvPG.jpg" },
    { id:"sauce", name:"ã‚½ãƒ¼ã‚¹", price:450, cat:"std", img:"https://ul.h3z.jp/wKg45O6e.JPG" },
  ];

  const IKASAMA = { id:"ikasama", name:"çœŸã£é»’ ã„ã‹ã•ã¾ç„¼ã", price:null, cat:"boss", img:"https://ul.h3z.jp/X0hNea3x.JPG" };

  const RECOMMEND = {
    rainy_or_humid: ["cheese_sauce_mayo", "negimiso", "mentai_mayo"],
    hot: ["karakuchi_sauce", "shio_kosho", "kaki_dashi", "suppin"],
    normal: ["sauce"]
  };
  const THRESH = { hotTempC: 25, humidRH: 78, rainMm: 0.1 };

  const HAKODATE = { lat: 41.7687, lon: 140.7288 };

  // =========================
  // UI
  // =========================
  const stackEl = document.getElementById("stack");
  const cName = document.getElementById("cName");
  const cMeta = document.getElementById("cMeta");
  const cPrice = document.getElementById("cPrice");

  const wxPill = document.getElementById("wxPill");
  const tmpPill = document.getElementById("tmpPill");
  const modePill = document.getElementById("modePill");

  const btnNext = document.getElementById("btnNext");
  const btnShuffle = document.getElementById("btnShuffle");

  const segRec = document.getElementById("segRec");
  const segStd = document.getElementById("segStd");
  const segPlus = document.getElementById("segPlus");
  const segBoss = document.getElementById("segBoss");
  const infoBox = document.getElementById("infoBox");

  // =========================
  // State
  // =========================
  let mode = "rec";              // rec/std/plus/boss
  let pool = [];                 // è¡¨ç¤ºä¸­ã®IDé…åˆ—
  let cardOrder = [];            // è¡¨ç¤ºä¸­ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é…åˆ—ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  let topIndex = 0;
  let lastPoolKey = "normal";
  let lastReason = "ãµã¤ã†ã®æ—¥";

  const yen = (n) => `ã€Š8å€‹ ${n}å††ã€‹`;
  const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const byId = (id) => MENU.find(x => x.id === id) || null;

  function setActiveSeg(target){
    [segRec, segStd, segPlus, segBoss].forEach(b => b.classList.toggle("active", b === target));
  }

  function setOverlay(m){
    cName.textContent = m.name;
    cPrice.textContent = (typeof m.price === "number") ? yen(m.price) : "ï¼ˆå‘³ã¯3ç¨®ï¼‰";
    cMeta.textContent = (mode === "boss")
      ? "ãŒã”ã‚æ˜†å¸ƒé†¤æ²¹ / ãƒ”ãƒ³ã‚¯å²©å¡© / ãƒ¬ãƒ¢ãƒ³ã‚½ãƒ«ãƒˆ"
      : "æŒ‡ã§å·¦å³ã«ã‚¹ãƒ¯ã‚¤ãƒ— â†’ æ¬¡ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼";
  }

  // =========================
  // Deck render
  // =========================
  function renderDeck(){
    stackEl.innerHTML = "";

    // æœ€å¤§4æšã¾ã§æŸã£ã½ãè¦‹ã›ã‚‹ï¼ˆè»½ã„ï¼‰
    const maxShow = Math.min(4, cardOrder.length);
    for(let d=0; d<maxShow; d++){
      const idx = (topIndex + d) % cardOrder.length;
      const m = cardOrder[idx];

      const card = document.createElement("div");
      card.className = "cardItem" + (d === 0 ? " isTop" : "");
      card.dataset.depth = String(d);

      card.innerHTML = `<img src="${m.img}" alt="${m.name}">`;

      // topã ã‘ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
      if(d === 0){
        attachSwipe(card);
        setOverlay(m);
      }

      stackEl.appendChild(card);
    }
  }

  // =========================
  // Swipe
  // =========================
  function attachSwipe(el){
    let startX = 0;
    let currentX = 0;
    let dragging = false;

    const onDown = (x) => {
      dragging = true;
      startX = x;
      currentX = x;
      el.classList.add("isDragging");
    };
    const onMove = (x) => {
      if(!dragging) return;
      currentX = x;
      const dx = currentX - startX;
      const rot = dx * 0.03;
      el.style.transform = `translate(${dx}px, 0) rotate(${rot}deg)`;
      el.style.opacity = String(Math.max(0.35, 1 - Math.abs(dx) / 360));
    };
    const onUp = () => {
      if(!dragging) return;
      dragging = false;
      el.classList.remove("isDragging");

      const dx = currentX - startX;
      const threshold = 90;

      if(Math.abs(dx) > threshold){
        // é£›ã°ã™
        const dir = dx > 0 ? 1 : -1;
        el.style.transition = "transform .18s ease, opacity .18s ease";
        el.style.transform = `translate(${dir * 520}px, 30px) rotate(${dir * 18}deg)`;
        el.style.opacity = "0";
        setTimeout(() => {
          nextCard();
        }, 140);
      }else{
        // æˆ»ã™
        el.style.transition = "transform .18s ease, opacity .18s ease";
        el.style.transform = "";
        el.style.opacity = "";
      }
    };

    // pointer events
    el.addEventListener("pointerdown", (e) => {
      el.setPointerCapture(e.pointerId);
      onDown(e.clientX);
    });
    el.addEventListener("pointermove", (e) => onMove(e.clientX));
    el.addEventListener("pointerup", onUp);
    el.addEventListener("pointercancel", onUp);
  }

  function nextCard(){
    topIndex = (topIndex + 1) % cardOrder.length;
    renderDeck();
  }

  function shuffle(){
    // Fisher-Yates
    for(let i=cardOrder.length-1; i>0; i--){
      const j = Math.floor(Math.random() * (i+1));
      [cardOrder[i], cardOrder[j]] = [cardOrder[j], cardOrder[i]];
    }
    topIndex = 0;
    renderDeck();
  }

  btnNext.addEventListener("click", nextCard);
  btnShuffle.addEventListener("click", shuffle);

  // =========================
  // Mode change
  // =========================
  function setMode(newMode){
    mode = newMode;

    if(mode === "boss"){
      modePill.textContent = "ã„ã‹ã•ã¾";
      cardOrder = [IKASAMA];
      infoBox.innerHTML = `
        <div class="k">çœŸã£é»’ ã„ã‹ã•ã¾ç„¼ã</div>
        <div class="p">å‘³ã¯3ç¨®é¡ï¼šãŒã”ã‚æ˜†å¸ƒé†¤æ²¹ / ãƒ”ãƒ³ã‚¯å²©å¡© / ãƒ¬ãƒ¢ãƒ³ã‚½ãƒ«ãƒˆ</div>
      `;
      renderDeck();
      return;
    }

    if(mode === "std"){
      modePill.textContent = "å®šç•ª450";
      cardOrder = MENU.filter(m => m.cat === "std");
      infoBox.innerHTML = `
        <div class="k">å®šç•ªï¼ˆ8å€‹450å††ï¼‰</div>
        <div class="p">ç‹é“ã®å®‰å®šã€‚è¿·ã£ãŸã‚‰ã€Œã‚½ãƒ¼ã‚¹ã€ã‹ã‚‰ã€‚</div>
      `;
      renderDeck();
      return;
    }

    if(mode === "plus"){
      modePill.textContent = "ã·ã‚‰ç™¾550";
      cardOrder = MENU.filter(m => m.cat === "plus");
      infoBox.innerHTML = `
        <div class="k">ã·ã‚‰ç™¾ï¼ˆ8å€‹550å††ï¼‰</div>
        <div class="p">æ°—åˆ†ã‚’ä¸Šã’ã‚‹â€œ+100å††ã®ä¸€æ‰‹â€ã€‚</div>
      `;
      renderDeck();
      return;
    }

    // rec
    modePill.textContent = "ãŠã™ã™ã‚";
    applyWeatherBasedPool(); // å¤©æ°—åˆ¤å®šã®çµæœã‹ã‚‰ä½œã‚‹
  }

  segRec.addEventListener("click", () => { setActiveSeg(segRec); setMode("rec"); });
  segStd.addEventListener("click", () => { setActiveSeg(segStd); setMode("std"); });
  segPlus.addEventListener("click", () => { setActiveSeg(segPlus); setMode("plus"); });
  segBoss.addEventListener("click", () => { setActiveSeg(segBoss); setMode("boss"); });

  // =========================
  // Weather
  // =========================
  async function fetchWeather(){
    const url =
      "https://api.open-meteo.com/v1/forecast" +
      `?latitude=${HAKODATE.lat}&longitude=${HAKODATE.lon}` +
      "&current_weather=true" +
      "&hourly=relative_humidity_2m,precipitation" +
      "&timezone=Asia%2FTokyo";

    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("weather fetch failed");
    const data = await res.json();

    const cw = data.current_weather || {};
    const tempC = (typeof cw.temperature === "number") ? cw.temperature : null;
    const wcode = (typeof cw.weathercode === "number") ? cw.weathercode : null;

    let rh = null, pr = null;
    try{
      const times = data.hourly?.time || [];
      const rhs = data.hourly?.relative_humidity_2m || [];
      const prs = data.hourly?.precipitation || [];
      const now = new Date();
      const nowIso = now.toISOString().slice(0,13);
      let idx = times.findIndex(t => t.startsWith(nowIso));
      if(idx < 0) idx = times.length - 1;
      rh = (typeof rhs[idx] === "number") ? rhs[idx] : null;
      pr = (typeof prs[idx] === "number") ? prs[idx] : null;
    }catch(_){}

    const weatherText = (() => {
      if(wcode == null) return "å¤©æ°—ï¼š--";
      if(wcode === 0) return "å¤©æ°—ï¼šå¿«æ™´";
      if(wcode >= 1 && wcode <= 3) return "å¤©æ°—ï¼šãã‚‚ã‚Š";
      if(wcode === 45 || wcode === 48) return "å¤©æ°—ï¼šéœ§";
      if((wcode >= 51 && wcode <= 67) || (wcode >= 80 && wcode <= 82) || wcode === 95) return "å¤©æ°—ï¼šé›¨";
      if(wcode >= 71 && wcode <= 77) return "å¤©æ°—ï¼šé›ª";
      return "å¤©æ°—ï¼šå¤‰åŒ–ã‚ã‚Š";
    })();

    return { tempC, rh, pr, wcode, weatherText };
  }

  function decidePool(wx){
    const tempC = wx.tempC;
    const rh = wx.rh;
    const pr = wx.pr;
    const wcode = wx.wcode;

    const isRainByCode = (wcode != null) && (
      (wcode >= 51 && wcode <= 67) || (wcode >= 80 && wcode <= 82) || wcode === 95
    );
    const isRainByMm = (pr != null) && (pr >= THRESH.rainMm);
    const isRain = isRainByCode || isRainByMm;

    const isHumid = (rh != null) && (rh >= THRESH.humidRH);
    const isHot = (tempC != null) && (tempC >= THRESH.hotTempC);

    if(isRain || isHumid) return { key:"rainy_or_humid", reason: (isRain ? "é›¨/æ¹¿åº¦" : "æ¹¿åº¦é«˜ã‚") };
    if(isHot) return { key:"hot", reason:"æš‘ã„æ—¥" };
    return { key:"normal", reason:"ãµã¤ã†ã®æ—¥" };
  }

  function applyWeatherBasedPool(){
    const ids = RECOMMEND[lastPoolKey] || RECOMMEND.normal;
    cardOrder = ids.map(id => byId(id)).filter(Boolean);
    if(cardOrder.length === 0) cardOrder = [byId("sauce")].filter(Boolean);

    infoBox.innerHTML = `
      <div class="k">ä»Šæ—¥ã®ãŠã™ã™ã‚ï¼ˆ${lastReason}ï¼‰</div>
      <div class="p">
        ${lastPoolKey === "rainy_or_humid" ? "é›¨ãƒ»æ¹¿åº¦é«˜ã‚ã¯ã€Œã“ã£ã¦ã‚Š/æ¿ƒã„å‘³ã€ãŒäººæ°—ã€‚" :
          lastPoolKey === "hot" ? "æš‘ã„æ—¥ã¯ã€Œã‚­ãƒ¬/ã ã—/ã‚·ãƒ³ãƒ—ãƒ«ã€ãŒäººæ°—ã€‚" :
          "ãµã¤ã†ã®æ—¥ã¯ç‹é“ã€Œã‚½ãƒ¼ã‚¹ã€ã€‚"}
        <br>ï¼ˆæŸã¯åŒæ¡ä»¶å†…ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§ãã¾ã™ï¼‰
      </div>
    `;
    topIndex = 0;
    renderDeck();
  }

  // =========================
  // init
  // =========================
  setMode("rec"); // å…ˆã«â€œä»®â€ã§è¡¨ç¤º

  (async () => {
    try{
      const wx = await fetchWeather();
      wxPill.textContent = wx.weatherText;
      tmpPill.textContent = (wx.tempC == null) ? "--â„ƒ" : `${Math.round(wx.tempC)}â„ƒ`;

      const pool = decidePool(wx);
      lastPoolKey = pool.key;
      lastReason = pool.reason;

      if(mode === "rec") applyWeatherBasedPool();
    }catch(e){
      wxPill.textContent = "å¤©æ°—ï¼šå–å¾—ã§ãã¾ã›ã‚“";
      tmpPill.textContent = "--â„ƒ";
      lastPoolKey = "normal";
      lastReason = "ãµã¤ã†ã®æ—¥ï¼ˆä»®ï¼‰";
      if(mode === "rec") applyWeatherBasedPool();
    }
  })();

})();
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>たこ焼き菜々｜焼きたてにこだわる たこ焼き屋</title>
<meta name="description" content="たこ焼き菜々公式。定番（8個450円）/ぷら百（8個550円）/真っ黒いかさま焼き。電話注文 070-4077-7732。焼き上がりまで約20分。" />

<style>
  :root{
    /* ===== 明るい背景 + 赤アクセント（単色の赤じゃない） ===== */
    --bg:#fff7f7;
    --bg2:#fffdf7;
    --card:#ffffff;
    --line: rgba(20,10,12,.12);
    --text:#1a1315;
    --muted: rgba(26,19,21,.68);

    --red1:#ff2d55; /* 鮮やか */
    --red2:#ff6a3d; /* 朱/オレンジ寄り */
    --red3:#ffb800; /* 黄寄り */
    --pink:#ff6bd6;
    --sky:#4aa8ff;

    --shadow: 0 18px 40px rgba(0,0,0,.10);
    --shadow2: 0 10px 24px rgba(0,0,0,.10);
    --r:18px;
    --max: 1120px;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family: system-ui,-apple-system,"Noto Sans JP",sans-serif;
    color:var(--text);
    background:
      radial-gradient(circle at 20% 10%, rgba(255,45,85,.10), transparent 40%),
      radial-gradient(circle at 85% 8%, rgba(74,168,255,.10), transparent 42%),
      radial-gradient(circle at 70% 75%, rgba(255,182,0,.10), transparent 45%),
      linear-gradient(180deg, var(--bg), var(--bg2));
  }

  a{ color:inherit; text-decoration:none }
  button{ font:inherit }
  img{ max-width:100%; display:block }

  .wrap{
    width:min(var(--max), 100%);
    margin:0 auto;
    padding: 14px 12px calc(22px + env(safe-area-inset-bottom));
  }

  /* ===== ヘッダー ===== */
  header{
    position:sticky;
    top:0;
    z-index:50;
    backdrop-filter: blur(10px);
    padding: 10px 0 12px;
  }
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding: 10px 12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.75);
    border-radius: 16px;
    box-shadow: var(--shadow2);
  }
  .brand{
    display:flex; align-items:center; gap:10px;
    min-width:0;
  }
  .logo{
    width:38px; height:38px; border-radius:12px;
    background:
      radial-gradient(circle at 35% 35%, rgba(255,255,255,.8), rgba(255,255,255,0) 55%),
      linear-gradient(135deg, var(--red1), var(--red2), var(--red3));
    box-shadow: 0 10px 22px rgba(255,45,85,.20);
    border:1px solid rgba(0,0,0,.06);
    flex:0 0 auto;
  }
  .brand .t{
    min-width:0;
  }
  .brand .name{
    font-weight: 1000;
    letter-spacing:.02em;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    line-height:1.1;
  }
  .brand .sub{
    margin-top:3px;
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .actions{
    display:flex; gap:8px; flex:0 0 auto; align-items:center;
  }
  .btn{
    border:1px solid var(--line);
    background: #fff;
    padding: 10px 12px;
    border-radius: 14px;
    cursor:pointer;
    display:inline-flex; align-items:center; gap:8px;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    box-shadow: 0 10px 20px rgba(0,0,0,.06);
    user-select:none;
  }
  .btn:hover{ transform: translateY(-1px); }
  .btn:active{ transform: translateY(0px) scale(.98); box-shadow:none; }
  .btn.call{
    background: linear-gradient(180deg, rgba(255,45,85,.12), rgba(255,255,255,1));
    border-color: rgba(255,45,85,.25);
  }
  .btn.ghost{
    background: rgba(255,255,255,.55);
  }

  /* ===== ヒーロー：今日のオススメ ===== */
  .hero{
    margin-top: 12px;
    border-radius: var(--r);
    border:1px solid var(--line);
    background: rgba(255,255,255,.78);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .heroInner{
    display:grid;
    grid-template-columns: 1.15fr .85fr;
    gap: 12px;
    padding: 14px;
    align-items:stretch;
  }
  @media (max-width:900px){
    .heroInner{ grid-template-columns: 1fr; }
  }

  .recPhoto{
    border-radius: 16px;
    overflow:hidden;
    border:1px solid rgba(0,0,0,.08);
    background: #f6f6f6;
    position:relative;
    min-height: 240px;
  }
  .recPhoto img{
    width:100%;
    height: 100%;
    object-fit: cover;
    aspect-ratio: 16/10;
  }
  .recRibbon{
    position:absolute;
    left: 12px; top: 12px;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  .pill{
    font-size: 12px;
    padding: 6px 10px;
    border-radius: 999px;
    border:1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.82);
    box-shadow: 0 10px 18px rgba(0,0,0,.08);
    font-weight: 800;
  }
  .pill.red{ border-color: rgba(255,45,85,.25); }
  .pill.sky{ border-color: rgba(74,168,255,.25); }
  .pill.sun{ border-color: rgba(255,182,0,.25); }
  .pill.gray{ border-color: rgba(0,0,0,.10); color: rgba(26,19,21,.80); }

  .recText{
    display:flex;
    flex-direction:column;
    gap: 10px;
  }
  .title{
    font-size: clamp(20px, 2.6vw, 30px);
    font-weight: 1000;
    letter-spacing:.02em;
    line-height:1.15;
    margin:0;
  }
  .lead{
    margin:0;
    color: var(--muted);
    line-height:1.7;
    font-size: 14px;
  }

  .recCard{
    border-radius: 16px;
    border:1px solid rgba(0,0,0,.08);
    background: #fff;
    padding: 12px;
    box-shadow: 0 12px 22px rgba(0,0,0,.06);
  }
  .recLine{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .recName{
    font-weight: 1000;
    letter-spacing:.02em;
    font-size: 16px;
    line-height:1.25;
  }
  .recPrice{
    font-weight: 1000;
    font-size: 14px;
    white-space:nowrap;
    color: rgba(26,19,21,.90);
  }
  .recNote{
    margin-top: 8px;
    font-size: 12px;
    color: var(--muted);
    line-height:1.7;
  }
  .recBtns{
    margin-top: 10px;
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .recBtns .btn{ flex:1 1 auto; justify-content:center; }

  /* ===== セクション ===== */
  .section{
    margin-top: 12px;
    border-radius: var(--r);
    border:1px solid var(--line);
    background: rgba(255,255,255,.78);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .head{
    padding: 12px 14px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    border-bottom: 1px solid rgba(0,0,0,.06);
    background:
      radial-gradient(circle at 15% 20%, rgba(255,45,85,.06), transparent 55%),
      radial-gradient(circle at 85% 25%, rgba(74,168,255,.06), transparent 55%),
      #fff;
  }
  .head .h{
    display:flex; align-items:center; gap:10px;
    font-weight: 1000;
    letter-spacing:.02em;
  }
  .dot{
    width:10px; height:10px; border-radius:99px;
    background: linear-gradient(180deg, var(--red1), var(--red2), var(--red3));
    box-shadow: 0 0 0 2px rgba(255,255,255,.9);
  }
  .head .sub{
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
    text-align:right;
  }
  .body{
    padding: 12px 14px 14px;
  }

  /* ===== メニュー：写真カードグリッド ===== */
  .menuGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  @media (max-width:980px){ .menuGrid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:560px){ .menuGrid{ grid-template-columns: 1fr; } }

  .mCard{
    border-radius: 16px;
    overflow:hidden;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    box-shadow: 0 12px 22px rgba(0,0,0,.06);
    display:flex;
    flex-direction:column;
    min-height: 100%;
  }
  .mPhoto{
    aspect-ratio: 4/3;
    background:#f3f3f3;
  }
  .mPhoto img{
    width:100%;
    height:100%;
    object-fit: cover;
  }
  .mBody{
    padding: 10px 10px 12px;
    display:flex;
    flex-direction:column;
    gap:6px;
    flex:1;
  }
  .mTop{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  }
  .mName{
    font-weight:1000;
    letter-spacing:.02em;
    line-height:1.25;
  }
  .mPrice{
    font-weight: 1000;
    white-space:nowrap;
    font-size: 13px;
    color: rgba(26,19,21,.88);
  }
  .tagRow{
    display:flex; gap:6px; flex-wrap:wrap;
  }
  .tag{
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    border:1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.92);
    color: rgba(26,19,21,.75);
  }
  .tag.std{ border-color: rgba(74,168,255,.22); }
  .tag.plus{ border-color: rgba(255,45,85,.22); }
  .tag.limited{ border-color: rgba(255,182,0,.28); }

  .mHint{
    margin-top:auto;
    font-size: 12px;
    color: var(--muted);
    line-height:1.6;
  }

  /* ===== いかさま焼き（特別枠） ===== */
  .feature{
    display:grid;
    grid-template-columns: 1.05fr .95fr;
    gap: 12px;
    align-items:stretch;
  }
  @media (max-width:900px){ .feature{ grid-template-columns: 1fr; } }

  .featurePhoto{
    border-radius: 16px;
    overflow:hidden;
    border:1px solid rgba(0,0,0,.08);
    background:#f3f3f3;
    box-shadow: 0 12px 22px rgba(0,0,0,.06);
  }
  .featurePhoto img{
    width:100%;
    height:100%;
    object-fit: cover;
    aspect-ratio: 16/10;
  }
  .featureBox{
    border-radius: 16px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    padding: 12px;
    box-shadow: 0 12px 22px rgba(0,0,0,.06);
  }
  .featureTitle{
    font-weight: 1100;
    letter-spacing:.02em;
    font-size: 18px;
    margin:0;
  }
  .featureDesc{
    margin: 8px 0 0;
    color: var(--muted);
    line-height:1.75;
    font-size: 14px;
  }
  .flavors{
    margin-top: 10px;
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
  }
  .flavor{
    border-radius: 999px;
    padding: 8px 10px;
    border:1px solid rgba(0,0,0,.10);
    background: linear-gradient(180deg, rgba(255,45,85,.06), rgba(255,255,255,.96));
    font-size: 12px;
    font-weight: 900;
  }

  /* ===== おもしろ要素：焼きたてタイマー ===== */
  .timerWrap{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    align-items:stretch;
  }
  @media (max-width:820px){ .timerWrap{ grid-template-columns: 1fr; } }

  .timerCard{
    border-radius: 16px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    padding: 12px;
    box-shadow: 0 12px 22px rgba(0,0,0,.06);
  }
  .timerTop{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .timerTitle{
    font-weight:1100;
    letter-spacing:.02em;
  }
  .time{
    font-variant-numeric: tabular-nums;
    font-weight: 1100;
    letter-spacing:.02em;
  }
  .bar{
    margin-top: 10px;
    height: 12px;
    border-radius: 999px;
    background: rgba(0,0,0,.06);
    overflow:hidden;
    border:1px solid rgba(0,0,0,.06);
  }
  .bar > i{
    display:block;
    height:100%;
    width:0%;
    background: linear-gradient(90deg, var(--red1), var(--red2), var(--red3));
    border-radius: 999px;
  }
  .timerNote{
    margin-top: 8px;
    font-size: 12px;
    color: var(--muted);
    line-height:1.7;
  }

  /* ===== フッター ===== */
  footer{
    margin-top: 14px;
    text-align:center;
    color: rgba(26,19,21,.70);
    font-size: 12px;
    line-height: 1.7;
    padding: 12px 6px 0;
  }
  .footerLinks{
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    margin-top: 10px;
  }

  /* ===== 小さな注釈 ===== */
  .small{
    font-size:12px;
    color: var(--muted);
    line-height:1.7;
  }
</style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="t">
          <div class="name">たこ焼き菜々</div>
          <div class="sub">焼きたてにこだわる｜電話注文：070-4077-7732</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn call" href="tel:07040777732">📞 電話注文</a>
        <a class="btn ghost" href="#menu">🍴 メニュー</a>
        <a class="btn ghost" href="https://takoyaki-trc.github.io/takoyaki-media/town/cardlist.html" target="_blank" rel="noopener">🌀 トレカ</a>
      </div>
    </div>
  </header>

  <!-- ===== HERO：天気×おすすめ（画像で） ===== -->
  <section class="hero" aria-label="今日のおすすめ">
    <div class="heroInner">
      <div class="recPhoto" aria-label="おすすめ写真">
        <img id="recImg" src="https://ul.h3z.jp/wKg45O6e.JPG" alt="おすすめメニュー画像" />
        <div class="recRibbon" aria-hidden="false">
          <span class="pill red" id="weatherPill">天気チェック中…</span>
          <span class="pill gray" id="tempPill">--℃</span>
          <span class="pill gray" id="reasonPill">おすすめ判定中</span>
        </div>
      </div>

      <div class="recText">
        <h1 class="title">今日のおすすめ、出ました。</h1>
        <p class="lead">
          天気・気温・湿度っぽさで、<b>おすすめが変わる</b>たこ焼き屋です。<br>
          （押すたびに同条件内でランダムに変わります）
        </p>

        <div class="recCard">
          <div class="recLine">
            <div class="recName" id="recName">ソース</div>
            <div class="recPrice" id="recPrice">《8個 450円》</div>
          </div>
          <div class="recNote" id="recNote">
            迷った日は、まずここ。今日の胃袋に一番スッと入るやつ。
          </div>

          <div class="recBtns">
            <button class="btn" id="btnReroll" type="button">🎲 別のおすすめ</button>
            <a class="btn call" href="tel:07040777732">📞 電話で頼む</a>
          </div>

          <div class="small" style="margin-top:10px" id="lastUpdate">
            最終更新：--:--
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== メニュー（写真で一覧） ===== -->
  <section class="section" id="menu" aria-label="メニュー一覧">
    <div class="head">
      <div class="h"><span class="dot"></span>メニュー（写真）</div>
      <div class="sub">定番 450円 / ぷら百 550円</div>
    </div>
    <div class="body">
      <div class="menuGrid" id="menuGrid"></div>
      <div class="small" style="margin-top:10px">
        ※ 価格は《8個》表記です。トッピング：無料2つまで（マヨ・一味マヨ・かつおぶし・山椒）／有料（ねぎ+50円、からしマヨ+50円）
      </div>
    </div>
  </section>

  <!-- ===== いかさま焼き ===== -->
  <section class="section" id="ikasama" aria-label="いかさま焼き">
    <div class="head">
      <div class="h"><span class="dot"></span>真っ黒 いかさま焼き</div>
      <div class="sub">味が選べる（3種）</div>
    </div>
    <div class="body">
      <div class="feature">
        <div class="featurePhoto">
          <img src="https://ul.h3z.jp/X0hNea3x.JPG" alt="真っ黒いかさま焼き" />
        </div>
        <div class="featureBox">
          <h2 class="featureTitle">見た目が強いのに、ちゃんと旨い。</h2>
          <p class="featureDesc">
            真っ黒いかさま焼きは、<b>味が3種類</b>。<br>
            「がごめ昆布醤油」「ピンク岩塩」「レモンソルト」から選べます。
          </p>
          <div class="flavors" aria-label="いかさま焼きの味">
            <span class="flavor">がごめ昆布醤油</span>
            <span class="flavor">ピンク岩塩</span>
            <span class="flavor">レモンソルト</span>
          </div>
          <div class="small" style="margin-top:10px">
            ※ 写真は“黒”の参考。味は注文時に選べます。
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== おもしろ要素：焼きたてタイマー ===== -->
  <section class="section" id="timer" aria-label="焼きたてタイマー">
    <div class="head">
      <div class="h"><span class="dot"></span>焼きたてタイマー（20分）</div>
      <div class="sub">押すと動く／遊び</div>
    </div>
    <div class="body">
      <div class="timerWrap">
        <div class="timerCard">
          <div class="timerTop">
            <div class="timerTitle">焼き上がりまで</div>
            <div class="time" id="timerText">20:00</div>
          </div>
          <div class="bar" aria-label="進捗バー"><i id="timerBar"></i></div>
          <div class="timerNote">
            ご注文をいただいてから焼き上げるため、<b>約20分</b>お時間を頂戴しています。<br>
            でも、その20分は「焼きたての価値」です。
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="timerStart" type="button">▶ 開始</button>
            <button class="btn" id="timerReset" type="button">↺ リセット</button>
          </div>
        </div>

        <div class="timerCard">
          <div class="timerTitle" style="font-weight:1100; letter-spacing:.02em;">お店の合言葉</div>
          <div style="margin-top:10px; padding:12px; border-radius:16px; border:1px solid rgba(0,0,0,.08); background: linear-gradient(180deg, rgba(255,45,85,.06), #fff);">
            <div style="font-weight:1100;">《今日もだれかがたこ焼きを食べている　菜々》</div>
            <div class="small" style="margin-top:8px;">
              ふつうの飲食店のサイトっぽくしないために、<br>
              “今日のおすすめ”と“焼きたてタイマー”で、来た瞬間に遊べるようにしました。
            </div>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <a class="btn call" href="tel:07040777732">📞 電話注文する</a>
            <a class="btn ghost" href="https://takoyaki-trc.github.io/takoyaki-media/town/cardlist.html" target="_blank" rel="noopener">🌀 トレカへ</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div><b>たこ焼き菜々</b>｜電話注文：<a href="tel:07040777732">070-4077-7732</a></div>
    <div>焼き上がりまで約20分（焼きたてにこだわっています）</div>
    <div class="footerLinks">
      <a class="btn ghost" href="#menu">🍴 メニュー</a>
      <a class="btn ghost" href="#ikasama">🖤 いかさま焼き</a>
      <a class="btn call" href="tel:07040777732">📞 注文</a>
      <a class="btn ghost" href="https://takoyaki-trc.github.io/takoyaki-media/town/cardlist.html" target="_blank" rel="noopener">🌀 トレカ</a>
    </div>
    <div style="margin-top:10px; opacity:.75;">《今日もだれかがたこ焼きを食べている　菜々》</div>
  </footer>

</div>

<script>
(() => {
  "use strict";

  // =========================
  // 1) メニュー定義（画像・価格）
  // =========================
  const MENU = [
    // --- ぷら百 / 550 ---
    { id:"teritama", name:"てりたま", price:550, cat:"plus", img:"https://ul.h3z.jp/S507mjUX.jpg", tags:["ぷら百","人気"] },
    { id:"negimiso", name:"ねぎ味噌", price:550, cat:"plus", img:"https://ul.h3z.jp/CcWfr8d0.JPG", tags:["ぷら百","雨の日人気"] },
    { id:"age_dama_karashi", name:"ぶっかけ揚げ玉からしマヨ", price:550, cat:"plus", img:"https://ul.h3z.jp/Z680luDn.JPG", tags:["ぷら百","こってり"] },
    { id:"shio_mayo_pepper", name:"塩マヨペッパー", price:550, cat:"plus", img:"https://ul.h3z.jp/hwUJtJOS.JPG", tags:["ぷら百","パンチ"] },
    { id:"cheese_sauce_mayo", name:"チーズソースマヨ", price:550, cat:"plus", img:"https://ul.h3z.jp/zQvjz2vk.JPG", tags:["ぷら百","雨/湿度人気"] },
    { id:"mentai_mayo", name:"めんたいマヨ", price:550, cat:"plus", img:"https://ul.h3z.jp/bibwTWq6.JPG", tags:["ぷら百","雨/湿度人気"] },

    // --- 定番 / 450 ---
    { id:"shio_kosho", name:"塩こしょう", price:450, cat:"std", img:"https://ul.h3z.jp/SLJuBJs1.jpg", tags:["定番","暑い日人気"] },
    { id:"suppin", name:"すっぴん", price:450, cat:"std", img:"https://ul.h3z.jp/mEuk5OwJ.jpg", tags:["定番","暑い日人気"] },
    { id:"karakuchi_sauce", name:"辛口ソース", price:450, cat:"std", img:"https://ul.h3z.jp/Jit1r3Jv.JPG", tags:["定番","暑い日人気"] },
    { id:"kaki_dashi", name:"牡蠣だし醤油", price:450, cat:"std", img:"https://ul.h3z.jp/k7J0DvPG.jpg", tags:["定番","暑い日人気"] },
    { id:"sauce", name:"ソース", price:450, cat:"std", img:"https://ul.h3z.jp/wKg45O6e.JPG", tags:["定番","迷ったらコレ"] },
  ];

  // いかさま焼き（別枠）
  const IKASAMA_IMG = "https://ul.h3z.jp/X0hNea3x.JPG";

  // =========================
  // 2) おすすめロジック（天気/気温/湿度）
  //    - 雨 or 湿度高め: チーズソースマヨ/ねぎ味噌/めんたいマヨ
  //    - 暑い日: 辛口ソース/塩こしょう/牡蠣だし醤油/すっぴん
  //    - それ以外: ソース
  // =========================
  const RECOMMEND = {
    rainy_or_humid: ["cheese_sauce_mayo", "negimiso", "mentai_mayo"],
    hot: ["karakuchi_sauce", "shio_kosho", "kaki_dashi", "suppin"],
    normal: ["sauce"]
  };

  // 閾値（ここは好みに合わせて調整OK）
  const THRESH = {
    hotTempC: 25,          // 25℃以上を“暑い日”
    humidRH: 78,           // 相対湿度 78%以上を“湿度高め”
    rainMm: 0.1            // 降水量 0.1mm以上で“雨っぽい”
  };

  // =========================
  // 3) UI参照
  // =========================
  const menuGrid = document.getElementById("menuGrid");

  const recImg = document.getElementById("recImg");
  const recName = document.getElementById("recName");
  const recPrice = document.getElementById("recPrice");
  const recNote = document.getElementById("recNote");

  const weatherPill = document.getElementById("weatherPill");
  const tempPill = document.getElementById("tempPill");
  const reasonPill = document.getElementById("reasonPill");
  const lastUpdate = document.getElementById("lastUpdate");

  const btnReroll = document.getElementById("btnReroll");

  // タイマー
  const timerText = document.getElementById("timerText");
  const timerBar = document.getElementById("timerBar");
  const timerStart = document.getElementById("timerStart");
  const timerReset = document.getElementById("timerReset");

  // =========================
  // 4) ユーティリティ
  // =========================
  const yen = (n) => `《8個 ${n}円》`;

  function pickRandom(arr){
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function findById(id){
    return MENU.find(x => x.id === id) || null;
  }

  function setPills({ weatherText, tempText, reasonText }){
    weatherPill.textContent = weatherText;
    tempPill.textContent = tempText;
    reasonPill.textContent = reasonText;
  }

  function setLastUpdate(ts){
    const d = new Date(ts);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    lastUpdate.textContent = `最終更新：${hh}:${mm}`;
  }

  // =========================
  // 5) メニュー表示（写真カード）
  // =========================
  function renderMenu(){
    menuGrid.innerHTML = "";
    const order = [
      // 550たち
      "teritama","negimiso","cheese_sauce_mayo","mentai_mayo","shio_mayo_pepper","age_dama_karashi",
      // 450たち
      "sauce","kaki_dashi","shio_kosho","karakuchi_sauce","suppin"
    ];

    order.forEach(id => {
      const m = findById(id);
      if(!m) return;

      const tagClass = (m.cat === "plus") ? "plus" : "std";
      const tagLabel = (m.cat === "plus") ? "ぷら百" : "定番";

      const tagsHtml = (m.tags || []).slice(0,3).map(t => `<span class="tag ${tagClass}">${t}</span>`).join("");

      const card = document.createElement("article");
      card.className = "mCard";
      card.innerHTML = `
        <div class="mPhoto">
          <img src="${m.img}" alt="${m.name}">
        </div>
        <div class="mBody">
          <div class="mTop">
            <div class="mName">${m.name}</div>
            <div class="mPrice">${yen(m.price)}</div>
          </div>
          <div class="tagRow">
            <span class="tag ${tagClass}">${tagLabel}</span>
            ${tagsHtml}
          </div>
          <div class="mHint">クリックで「今日のおすすめ」にセットできます。</div>
        </div>
      `;
      card.style.cursor = "pointer";
      card.addEventListener("click", () => {
        applyRecommendation(m.id, "手動で選択");
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      menuGrid.appendChild(card);
    });
  }

  // =========================
  // 6) おすすめの表示を適用
  // =========================
  function applyRecommendation(menuId, reason){
    const m = findById(menuId) || findById("sauce");
    recImg.src = m.img;
    recImg.alt = m.name;
    recName.textContent = m.name;
    recPrice.textContent = yen(m.price);

    // ちょい面白い一言（短く）
    const notes = {
      cheese_sauce_mayo: "雨の日、湿度の高い日に“欲しくなる系”。",
      negimiso: "雨の日に強い。体が“味噌”を求めるらしい。",
      mentai_mayo: "湿度が高いと、なぜか明太が勝つ。",
      karakuchi_sauce: "暑い日は辛口でスイッチを入れる。",
      shio_kosho: "暑い日にキリッと。軽いのに満足感。",
      kaki_dashi: "暑い日に“だし”が沁みる。静かな強さ。",
      suppin: "暑い日は原点回帰。余計なものがいらない。",
      sauce: "迷ったらコレ。王道は、いつだって強い。",
      teritama: "甘みとコクで、気分が上がる550。",
      age_dama_karashi: "ガツンといきたい時の“やんちゃ枠”。",
      shio_mayo_pepper: "塩×マヨ×ペッパー。大人の背徳。",
    };
    recNote.textContent = (notes[m.id] || "今日の気分に合う一皿。") + `（${reason}）`;

    // 保存（同条件での“リロール”用）
    localStorage.setItem("nana_rec_last", m.id);
  }

  // =========================
  // 7) 天気取得（Open-Meteo / 無料 / APIキー不要）
  //    店が函館前提：lat/lon固定
  // =========================
  const HAKODATE = { lat: 41.7687, lon: 140.7288 };

  async function fetchWeather(){
    // current_weather: temp, wind, weathercode
    // hourly: relative_humidity_2m, precipitation
    const url =
      "https://api.open-meteo.com/v1/forecast" +
      `?latitude=${HAKODATE.lat}&longitude=${HAKODATE.lon}` +
      "&current_weather=true" +
      "&hourly=relative_humidity_2m,precipitation" +
      "&timezone=Asia%2FTokyo";

    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("weather fetch failed");
    const data = await res.json();

    const cw = data.current_weather || {};
    const tempC = (typeof cw.temperature === "number") ? cw.temperature : null;
    const wcode = (typeof cw.weathercode === "number") ? cw.weathercode : null;

    // “今の時間”に最も近いhourlyを探す
    let rh = null, pr = null;
    try{
      const times = data.hourly?.time || [];
      const rhs = data.hourly?.relative_humidity_2m || [];
      const prs = data.hourly?.precipitation || [];
      const now = new Date();
      const nowIso = now.toISOString().slice(0,13); // YYYY-MM-DDTHH
      let idx = times.findIndex(t => t.startsWith(nowIso));
      if(idx < 0) idx = times.length - 1;
      rh = (typeof rhs[idx] === "number") ? rhs[idx] : null;
      pr = (typeof prs[idx] === "number") ? prs[idx] : null;
    }catch(_){}

    // 天気ラベル（ざっくり）
    const weatherText = (() => {
      if(wcode == null) return "天気：--";
      // Open-Meteo weathercode: 0 clear, 1-3 partly, 45/48 fog, 51-67 drizzle/rain, 71-77 snow, 80-82 rain showers, 95 thunder
      if(wcode === 0) return "天気：快晴";
      if(wcode >= 1 && wcode <= 3) return "天気：くもり";
      if(wcode === 45 || wcode === 48) return "天気：霧";
      if((wcode >= 51 && wcode <= 67) || (wcode >= 80 && wcode <= 82) || wcode === 95) return "天気：雨";
      if(wcode >= 71 && wcode <= 77) return "天気：雪";
      return "天気：変化あり";
    })();

    return { tempC, rh, pr, wcode, weatherText };
  }

  function decidePool(wx){
    const tempC = wx.tempC;
    const rh = wx.rh;
    const pr = wx.pr;
    const wcode = wx.wcode;

    const isRainByCode = (wcode != null) && (
      (wcode >= 51 && wcode <= 67) || (wcode >= 80 && wcode <= 82) || wcode === 95
    );
    const isRainByMm = (pr != null) && (pr >= THRESH.rainMm);
    const isRain = isRainByCode || isRainByMm;

    const isHumid = (rh != null) && (rh >= THRESH.humidRH);
    const isHot = (tempC != null) && (tempC >= THRESH.hotTempC);

    if(isRain || isHumid){
      return { key:"rainy_or_humid", reason: (isRain ? "雨/湿度" : "湿度高め") };
    }
    if(isHot){
      return { key:"hot", reason:"暑い日" };
    }
    return { key:"normal", reason:"ふつうの日" };
  }

  function reroll(poolKey, reason){
    const ids = RECOMMEND[poolKey] || RECOMMEND.normal;
    const pick = pickRandom(ids);
    applyRecommendation(pick, `天気判定：${reason} → ランダム`);
  }

  // =========================
  // 8) リロールボタン
  // =========================
  let lastPoolKey = "normal";
  let lastReason = "ふつうの日";

  btnReroll.addEventListener("click", () => {
    reroll(lastPoolKey, lastReason);
  });

  // =========================
  // 9) タイマー（20分）
  // =========================
  const TOTAL = 20 * 60; // seconds
  let tLeft = TOTAL;
  let timer = null;

  function drawTimer(){
    const m = Math.floor(tLeft / 60);
    const s = tLeft % 60;
    timerText.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    const done = (TOTAL - tLeft) / TOTAL;
    timerBar.style.width = `${Math.max(0, Math.min(1, done)) * 100}%`;
  }

  function stopTimer(){
    if(timer){ clearInterval(timer); timer = null; }
  }

  timerStart.addEventListener("click", () => {
    if(timer) return; // 二重起動防止
    timer = setInterval(() => {
      tLeft = Math.max(0, tLeft - 1);
      drawTimer();
      if(tLeft <= 0){
        stopTimer();
        // ちいさく祝う（派手すぎない）
        timerText.textContent = "できた！";
      }
    }, 1000);
  });

  timerReset.addEventListener("click", () => {
    stopTimer();
    tLeft = TOTAL;
    drawTimer();
  });

  // =========================
  // 起動
  // =========================
  renderMenu();
  drawTimer();

  // 初期：前回のおすすめがあれば先に出す（体感が良い）
  const last = localStorage.getItem("nana_rec_last");
  if(last && findById(last)){
    applyRecommendation(last, "前回の表示");
  }else{
    applyRecommendation("sauce", "初期表示");
  }

  // 天気取得しておすすめ更新
  (async () => {
    try{
      const wx = await fetchWeather();
      const tempText = (wx.tempC == null) ? "--℃" : `${Math.round(wx.tempC)}℃`;
      const humidityText = (wx.rh == null) ? "" : ` / 湿度 ${Math.round(wx.rh)}%`;
      const rainText = (wx.pr == null) ? "" : ` / 降水 ${wx.pr.toFixed(1)}mm`;
      const pool = decidePool(wx);

      lastPoolKey = pool.key;
      lastReason = pool.reason;

      setPills({
        weatherText: wx.weatherText,
        tempText: tempText,
        reasonText: `${pool.reason}${humidityText}${rainText}`
      });

      reroll(pool.key, pool.reason);
      setLastUpdate(Date.now());
    }catch(e){
      // 失敗時は“普通の日”として扱う
      lastPoolKey = "normal";
      lastReason = "ふつうの日（天気取得失敗）";
      setPills({
        weatherText: "天気：取得できませんでした",
        tempText: "--℃",
        reasonText: "おすすめ：ソース（仮）"
      });
      applyRecommendation("sauce", "天気取得失敗 → 安定の王道");
      setLastUpdate(Date.now());
    }
  })();

})();
</script>
</body>
</html>
